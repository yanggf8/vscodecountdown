name: 'Community Metrics Report'
on:
  schedule:
    - cron: '0 0 1 * *'  # æ¯æœˆ1è™ŸåŸ·è¡Œ
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  generate-metrics:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: read
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Generate Community Metrics
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          const owner = context.repo.owner;
          const repo = context.repo.repo;
          
          // è¨ˆç®—æ™‚é–“ç¯„åœ (éå»30å¤©)
          const endDate = new Date();
          const startDate = new Date();
          startDate.setDate(startDate.getDate() - 30);
          
          console.log(`ç”Ÿæˆå ±å‘Šæ™‚é–“ç¯„åœ: ${startDate.toISOString()} åˆ° ${endDate.toISOString()}`);
          
          try {
            // ç²å– Issues æ•¸æ“š
            const issues = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'all',
              since: startDate.toISOString(),
              per_page: 100
            });
            
            // ç²å– Pull Requests æ•¸æ“š
            const prs = await github.rest.pulls.list({
              owner,
              repo,
              state: 'all',
              per_page: 100
            });
            
            // éæ¿¾éå»30å¤©çš„æ•¸æ“š
            const recentPRs = prs.data.filter(pr => 
              new Date(pr.created_at) >= startDate
            );
            
            // çµ±è¨ˆæ•¸æ“š
            const stats = {
              issues: {
                total: issues.data.length,
                opened: issues.data.filter(issue => !issue.pull_request).length,
                closed: issues.data.filter(issue => !issue.pull_request && issue.state === 'closed').length,
                bugs: issues.data.filter(issue => 
                  issue.labels.some(label => label.name === 'bug')
                ).length,
                enhancements: issues.data.filter(issue => 
                  issue.labels.some(label => label.name === 'enhancement')
                ).length
              },
              prs: {
                total: recentPRs.length,
                opened: recentPRs.filter(pr => pr.state === 'open').length,
                merged: recentPRs.filter(pr => pr.merged_at).length,
                closed: recentPRs.filter(pr => pr.state === 'closed' && !pr.merged_at).length
              },
              contributors: new Set([
                ...issues.data.map(issue => issue.user.login),
                ...recentPRs.map(pr => pr.user.login)
              ]).size
            };
            
            // ç”Ÿæˆå ±å‘Šå…§å®¹
            const reportDate = endDate.toISOString().split('T')[0];
            const reportContent = [
              '# ç¤¾ç¾¤æœˆå ± - ' + reportDate,
              '',
              '## ğŸ“Š æœ¬æœˆçµ±è¨ˆæ•¸æ“š',
              '',
              '### Issues çµ±è¨ˆ',
              '- **æ–°å»º Issues**: ' + stats.issues.opened,
              '- **å·²é—œé–‰ Issues**: ' + stats.issues.closed,
              '- **Bug å ±å‘Š**: ' + stats.issues.bugs,
              '- **åŠŸèƒ½è«‹æ±‚**: ' + stats.issues.enhancements,
              '',
              '### Pull Requests çµ±è¨ˆ',
              '- **æ–°å»º PRs**: ' + stats.prs.total,
              '- **å·²åˆä½µ PRs**: ' + stats.prs.merged,
              '- **é€²è¡Œä¸­ PRs**: ' + stats.prs.opened,
              '- **å·²é—œé–‰æœªåˆä½µ**: ' + stats.prs.closed,
              '',
              '### ç¤¾ç¾¤åƒèˆ‡',
              '- **æ´»èºè²¢ç»è€…**: ' + stats.contributors + ' äºº',
              '- **Issue å¹³å‡å›æ‡‰æ™‚é–“**: è¨ˆç®—ä¸­...',
              '- **PR å¹³å‡è™•ç†æ™‚é–“**: è¨ˆç®—ä¸­...',
              '',
              '## ğŸ¯ æœ¬æœˆäº®é»',
              '',
              '### ä¸»è¦æˆå°±',
              '- ğŸš€ æ–°ç‰ˆæœ¬ç™¼ä½ˆ',
              '- ğŸ› ä¿®å¾©é‡è¦ Bugs',
              '- ğŸ’¡ å¯¦ç¾ç¤¾ç¾¤å»ºè­°åŠŸèƒ½',
              '- ğŸ“š æ–‡æª”æ”¹é€²',
              '',
              '### æ„Ÿè¬è²¢ç»è€…',
              'æ„Ÿè¬æœ¬æœˆæ‰€æœ‰åƒèˆ‡è²¢ç»çš„ç¤¾ç¾¤æˆå“¡ï¼',
              '',
              '## ğŸ“ˆ è¶¨å‹¢åˆ†æ',
              '',
              '### Issue è™•ç†æ•ˆç‡',
              '- Issue å›æ‡‰æ™‚é–“ç›®æ¨™: å°æ–¼ 24 å°æ™‚',
              '- æœ¬æœˆé”æˆç‡: è¨ˆç®—ä¸­...',
              '',
              '### ç¤¾ç¾¤æˆé•·',
              '- æ–°è²¢ç»è€…æ•¸é‡: ' + Math.max(0, stats.contributors - 5) + ' äºº',
              '- ç¤¾ç¾¤æ´»èºåº¦: ' + (stats.issues.total + stats.prs.total) + ' æ¬¡äº’å‹•',
              '',
              '## ğŸ¯ ä¸‹æœˆè¨ˆåŠƒ',
              '',
              '### å„ªå…ˆä»»å‹™',
              '- [ ] è™•ç†å¾…ä¿®å¾©çš„ Bug',
              '- [ ] å¯¦ç¾è¨ˆåŠƒä¸­çš„æ–°åŠŸèƒ½',
              '- [ ] æ”¹å–„æ–‡æª”å’Œä½¿ç”¨æŒ‡å—',
              '- [ ] ç¤¾ç¾¤æ´»å‹•è¦åŠƒ',
              '',
              '### éœ€è¦å¹«åŠ©çš„é ˜åŸŸ',
              '- ğŸ§ª æ¸¬è©¦æ¡ˆä¾‹è£œå……',
              '- ğŸ“ æ–‡æª”ç¿»è­¯',
              '- ğŸ¨ UI/UX æ”¹é€²',
              '- ğŸ› Bug ä¿®å¾©',
              '',
              '## ğŸ“ è¯ç¹«æˆ‘å€‘',
              '',
              'æœ‰ä»»ä½•å•é¡Œæˆ–å»ºè­°ï¼Œæ­¡è¿ï¼š',
              '- åœ¨ [GitHub Discussions](https://github.com/' + owner + '/' + repo + '/discussions) åƒèˆ‡è¨è«–',
              '- æäº¤ [Issues](https://github.com/' + owner + '/' + repo + '/issues) å›å ±å•é¡Œ',
              '- æŸ¥çœ‹ [è²¢ç»æŒ‡å—](https://github.com/' + owner + '/' + repo + '/blob/main/CONTRIBUTING.md)',
              '',
              '---',
              '*æ­¤å ±å‘Šç”± GitHub Actions è‡ªå‹•ç”Ÿæˆæ–¼ ' + reportDate + '*'
            ].join('\n');

            // ä¿å­˜å ±å‘Šåˆ°æ–‡ä»¶
            fs.writeFileSync('community-metrics.md', reportContent);
            
            // å‰µå»º Issue ç™¼ä½ˆå ±å‘Š
            const issueTitle = 'ğŸ“Š ç¤¾ç¾¤æœˆå ± - ' + reportDate;
            const issueBody = reportContent + '\n\n## ğŸ“ è¨è«–\n\nè«‹åœ¨æ­¤ Issue ä¸‹æ–¹ç•™è¨€ï¼š\n- å°æœ¬æœˆæ•¸æ“šçš„çœ‹æ³•\n- å°ä¸‹æœˆè¨ˆåŠƒçš„å»ºè­°\n- æƒ³è¦åƒèˆ‡çš„æ´»å‹•æˆ–ä»»å‹™';

            await github.rest.issues.create({
              owner: owner,
              repo: repo,
              title: issueTitle,
              body: issueBody,
              labels: ['monthly-report', 'community', 'pinned']
            });
            
            console.log('ç¤¾ç¾¤æœˆå ±å·²ç”Ÿæˆä¸¦ç™¼ä½ˆç‚º Issue');
            
          } catch (error) {
            console.error('ç”Ÿæˆç¤¾ç¾¤å ±å‘Šæ™‚å‡ºéŒ¯:', error);
            throw error;
          }

    - name: Commit metrics report
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add community-metrics.md
        git commit -m "ğŸ“Š è‡ªå‹•ç”Ÿæˆç¤¾ç¾¤æœˆå ± $(date +'%Y-%m-%d')" || exit 0
        git push || exit 0